<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Camera Stream</title>
  <style>
    body {
      margin: 0;
      background-color: black;
      font-family: sans-serif;
      color: white;
      overflow: hidden;
    }
    #stream {
      display: block;
      width: 100vw;
      height: 100vh;
      object-fit: contain;
      background-color: black;
    }
    #hud {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.5);
      padding: 10px;
      border-radius: 8px;
    }
    #hud div {
      margin-bottom: 5px;
    }
    #reconnect {
      background: #444;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
    }
    #reconnect:hover {
      background: #666;
    }
    #error {
      color: red;
    }
  </style>
</head>
<body>
  <img id="stream" src="" alt="FPV Stream" />
  <div id="hud">
    <div>üì∂ Status: <span id="status">Connecting...</span></div>
    <div>‚è± FPS: <span id="fps">0</span></div>
    <button id="reconnect">Reconnect</button>
    <div id="error"></div>
  </div>

  <script>
    const img = document.getElementById("stream");
    const statusSpan = document.getElementById("status");
    const fpsSpan = document.getElementById("fps");
    const errorDiv = document.getElementById("error");
    const reconnectBtn = document.getElementById("reconnect");

    let ws;
    let frameTimes = [];
    let reconnectTimeout;

    function updateFPS() {
      const now = performance.now();
      frameTimes = frameTimes.filter(t => now - t < 5000);
      fpsSpan.textContent = (frameTimes.length / 5).toFixed(1);
    }

    function connect() {
      errorDiv.textContent = "";
      statusSpan.textContent = "Connecting...";

      ws = new WebSocket("ws://" + location.host + "/ws");

      ws.onopen = () => {
        statusSpan.textContent = "Connected";
        if (reconnectTimeout) {
          clearTimeout(reconnectTimeout);
        }
      };

      ws.onclose = () => {
        statusSpan.textContent = "Disconnected";
        // Auto-reconnect after 5 seconds
        reconnectTimeout = setTimeout(() => {
          if (ws.readyState !== WebSocket.OPEN) {
            connect();
          }
        }, 5000);
      };

      ws.onerror = (err) => {
        statusSpan.textContent = "Error";
        errorDiv.textContent = "WebSocket error. Check console for details.";
        console.error("WebSocket error:", err);
      };

      ws.onmessage = async (event) => {
        const image = await event.data;
        img.src = image;

        frameTimes.push(performance.now());
        updateFPS();
      };
    }

    reconnectBtn.onclick = () => {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.close();
      }
      try {
        connect();
      } catch (err) {
        errorDiv.textContent = "‚ùå Failed to reconnect.";
      }
    };

    connect();
  </script>
</body>
</html>