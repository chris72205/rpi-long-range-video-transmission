<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Camera Stream</title>
  <style>
    body {
      margin: 0;
      background-color: black;
      font-family: sans-serif;
      color: white;
      overflow: hidden;
    }
    #stream {
      display: block;
      width: 100vw;
      height: 100vh;
      object-fit: contain;
      background-color: black;
    }
    #hud {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.5);
      padding: 10px;
      border-radius: 8px;
    }
    #hud div {
      margin-bottom: 5px;
    }
    #reconnect {
      background: #444;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
    }
    #reconnect:hover {
      background: #666;
    }
    #error {
      color: red;
    }
    .resolution-control {
      display: flex;
      align-items: center;
      gap: 5px;
      margin-bottom: 5px;
    }
    .resolution-control input {
      width: 60px;
      padding: 2px;
    }
    .resolution-control button {
      background: #444;
      color: white;
      border: none;
      padding: 2px 8px;
      border-radius: 3px;
      cursor: pointer;
    }
    .resolution-control button:hover {
      background: #666;
    }
    .resolution-info {
      font-size: 0.9em;
      color: #aaa;
      margin-top: 2px;
    }
    .current-resolution {
      font-size: 0.9em;
      color: #0f0;
      margin-top: 2px;
    }
  </style>
</head>
<body>
  <img id="stream" src="" alt="FPV Stream" />
  <div id="hud">
    <div>üì∂ Status: <span id="status">Connecting...</span></div>
    <div>‚è± FPS: <span id="fps">0</span></div>
    <div class="current-resolution">
      Current Resolution: <span id="currentResolution">-</span>
    </div>
    <div class="resolution-control">
      <label>Width:</label>
      <input type="number" id="width" value="2048" min="640" max="4096" step="32">
      <button id="setResolution">Set Resolution</button>
    </div>
    <div class="resolution-info">
      Height will be automatically calculated to maintain 4:3 aspect ratio
    </div>
    <button id="reconnect">Reconnect</button>
    <div id="error"></div>
  </div>

  <script>
    const img = document.getElementById("stream");
    const statusSpan = document.getElementById("status");
    const fpsSpan = document.getElementById("fps");
    const errorDiv = document.getElementById("error");
    const reconnectBtn = document.getElementById("reconnect");
    const widthInput = document.getElementById("width");
    const setResolutionBtn = document.getElementById("setResolution");
    const currentResolutionSpan = document.getElementById("currentResolution");

    let ws;
    let frameTimes = [];
    let reconnectTimeout;

    function calculateHeight(width) {
      // Maintain 4:3 aspect ratio
      return Math.round((width * 3) / 4);
    }

    function updateFPS() {
      const now = performance.now();
      frameTimes = frameTimes.filter(t => now - t < 5000);
      fpsSpan.textContent = (frameTimes.length / 5).toFixed(1);
    }

    function updateCurrentResolution(width, height) {
      currentResolutionSpan.textContent = `${width}√ó${height}`;
    }

    function setResolution() {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        errorDiv.textContent = "‚ùå Not connected. Cannot change resolution.";
        return;
      }

      const width = parseInt(widthInput.value);
      const height = calculateHeight(width);

      if (width < 640 || width > 4096) {
        errorDiv.textContent = "‚ùå Invalid width. Must be between 640 and 4096.";
        return;
      }

      ws.send(JSON.stringify({
        type: 'set_size',
        width: width,
        height: height
      }));
    }

    function connect() {
      errorDiv.textContent = "";
      statusSpan.textContent = "Connecting...";

      ws = new WebSocket("ws://" + location.host + "/ws");

      ws.onopen = () => {
        statusSpan.textContent = "Connected";
        if (reconnectTimeout) {
          clearTimeout(reconnectTimeout);
        }
      };

      ws.onclose = () => {
        statusSpan.textContent = "Disconnected";
        // Auto-reconnect after 5 seconds
        reconnectTimeout = setTimeout(() => {
          if (ws.readyState !== WebSocket.OPEN) {
            connect();
          }
        }, 5000);
      };

      ws.onerror = (err) => {
        statusSpan.textContent = "Error";
        errorDiv.textContent = "WebSocket error. Check console for details.";
        console.error("WebSocket error:", err);
      };

      ws.onmessage = async (event) => {
        try {
          // Try to parse as JSON first (for resolution info)
          const data = JSON.parse(event.data);
          if (data.type === 'resolution_info') {
            updateCurrentResolution(data.width, data.height);
            return;
          }
        } catch (e) {
          // If not JSON, treat as image data
          const image = event.data;
          img.src = image;
          frameTimes.push(performance.now());
          updateFPS();
        }
      };
    }

    reconnectBtn.onclick = () => {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.close();
      }
      try {
        connect();
      } catch (err) {
        errorDiv.textContent = "‚ùå Failed to reconnect.";
      }
    };

    setResolutionBtn.onclick = setResolution;

    connect();
  </script>
</body>
</html>